<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Vue源码学习 | 千伶百俐 戴月披星</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="预计这会是一篇需要持续更新的博客了，暂时涉及到的大概有Vue函数、双向绑定、虚拟DOM、diff算法。">
<meta name="keywords" content="前端工程师">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue源码学习">
<meta property="og:url" content="http://yoursite.com/2019/01/13/Vue源码学习/index.html">
<meta property="og:site_name" content="千伶百俐 戴月披星">
<meta property="og:description" content="预计这会是一篇需要持续更新的博客了，暂时涉及到的大概有Vue函数、双向绑定、虚拟DOM、diff算法。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-06-23T08:47:25.478Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vue源码学习">
<meta name="twitter:description" content="预计这会是一篇需要持续更新的博客了，暂时涉及到的大概有Vue函数、双向绑定、虚拟DOM、diff算法。">
  
    <link rel="alternate" href="/wdzhao.github.io/atom.xml" title="千伶百俐 戴月披星" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/wdzhao.github.io/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/wdzhao.github.io/" id="logo">千伶百俐 戴月披星</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/wdzhao.github.io/" id="subtitle">做一个思想者！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/wdzhao.github.io/">Home</a>
        
          <a class="main-nav-link" href="/wdzhao.github.io/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/wdzhao.github.io/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Vue源码学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wdzhao.github.io/2019/01/13/Vue源码学习/" class="article-date">
  <time datetime="2019-01-13T04:29:50.000Z" itemprop="datePublished">2019-01-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Vue源码学习
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>预计这会是一篇需要持续更新的博客了，暂时涉及到的大概有Vue函数、双向绑定、虚拟DOM、diff算法。</p>
<a id="more"></a>
<p>先来看下Vue源码的结构目录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">├── build <span class="comment">----------------------------- 构建相关的文件，一般情况下我们不需要动 </span></span><br><span class="line">├── dist <span class="comment">------------------------------ 构建后文件的输出目录 </span></span><br><span class="line">├── examples <span class="comment">-------------------------- 存放一些使用Vue开发的应用案例 </span></span><br><span class="line">├── flow <span class="comment">------------------------------ 类型声明，使用开源项目 [Flow](https://flowtype.org/) </span></span><br><span class="line">├── package.json <span class="comment">---------------------- 不解释 </span></span><br><span class="line">├── test <span class="comment">------------------------------ 包含所有测试文件 </span></span><br><span class="line">├── src <span class="comment">------------------------------- 这个是我们最应该关注的目录，包含了源码 </span></span><br><span class="line">│ ├── entries <span class="comment">------------------------- 包含了不同的构建或包的入口文件 </span></span><br><span class="line">│ │ ├── web-runtime.js <span class="comment">---------------- 运行时构建的入口，输出 dist/vue.common.js 文件，不包含模板(template)到render函数的编译器，所以不支持 `template` 选项，我们使用vue默认导出的就是这个运行时的版本。大家使用的时候要注意 </span></span><br><span class="line">│ │ ├── web-runtime-<span class="keyword">with</span>-compiler.js <span class="comment">-- 独立构建版本的入口，输出 dist/vue.js，它包含模板(template)到render函数的编译器 </span></span><br><span class="line">│ │ ├── web-compiler.js <span class="comment">--------------- vue-template-compiler 包的入口文件 </span></span><br><span class="line">│ │ ├── web-<span class="keyword">server</span>-renderer.js <span class="comment">-------- vue-server-renderer 包的入口文件 </span></span><br><span class="line">│ ├── compiler <span class="comment">------------------------ 编译器代码的存放目录，将 template 编译为 render 函数 </span></span><br><span class="line">│ │ ├── parser <span class="comment">------------------------ 存放将模板字符串转换成元素抽象语法树的代码 </span></span><br><span class="line">│ │ ├── codegen <span class="comment">----------------------- 存放从抽象语法树(AST)生成render函数的代码 </span></span><br><span class="line">│ │ ├── optimizer.js <span class="comment">------------------ 分析静态树，优化vdom渲染 </span></span><br><span class="line">│ ├── core <span class="comment">---------------------------- 存放通用的，平台无关的代码 </span></span><br><span class="line">│ │ ├── observer <span class="comment">---------------------- 反应系统，包含数据观测的核心代码 </span></span><br><span class="line">│ │ ├── vdom <span class="comment">-------------------------- 包含虚拟DOM创建(creation)和打补丁(patching)的代码 </span></span><br><span class="line">│ │ ├── <span class="keyword">instance</span> <span class="comment">---------------------- 包含Vue构造函数设计相关的代码 </span></span><br><span class="line">│ │ ├── <span class="keyword">global</span>-api <span class="comment">-------------------- 包含给Vue构造函数挂载全局方法(静态方法)或属性的代码 </span></span><br><span class="line">│ │ ├── components <span class="comment">-------------------- 包含抽象出来的通用组件 </span></span><br><span class="line">│ ├── <span class="keyword">server</span> <span class="comment">-------------------------- 包含服务端渲染(server-side rendering)的相关代码 </span></span><br><span class="line">│ ├── platforms <span class="comment">----------------------- 包含平台特有的相关代码 </span></span><br><span class="line">│ ├── sfc <span class="comment">----------------------------- 包含单文件组件(.vue文件)的解析逻辑，用于vue-template-compiler包 </span></span><br><span class="line">│ ├── <span class="keyword">shared</span> <span class="comment">-------------------------- 包含整个代码库通用的代码</span></span><br></pre></td></tr></table></figure>
<h1 id="常用的NPM脚本"><a href="#常用的NPM脚本" class="headerlink" title="常用的NPM脚本"></a>常用的NPM脚本</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">＃表和自动重新构建DIST / vue.js</span><br><span class="line">$ npm <span class="builtin-name">run</span> dev</span><br><span class="line"></span><br><span class="line">＃在Chrome手表和自动重新运行单元测试</span><br><span class="line">$ npm <span class="builtin-name">run</span> dev：test</span><br><span class="line"></span><br><span class="line">＃建立所有DIST文件，包括NPM包</span><br><span class="line">$ npm <span class="builtin-name">run</span> build</span><br><span class="line"></span><br><span class="line">＃运行完整的测试套件，包括linting /<span class="built_in"> type </span>checking </span><br><span class="line">$ npm test</span><br></pre></td></tr></table></figure>
<p>package.json文件中还有其他一些脚本可用。来看npm run dev做了些什么，</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dev<span class="string">": "</span>rollup -w -c scripts/<span class="built_in">config</span>.js <span class="comment">--environment TARGET:web-full-dev",</span></span><br></pre></td></tr></table></figure>
<p>rollup时一个与webpack类似的js打包器，后续再来详细了解下。-w -c分别是指watch和指定配置文件build/config.js</p>
<h1 id="一步步来实现Vue双向绑定"><a href="#一步步来实现Vue双向绑定" class="headerlink" title="一步步来实现Vue双向绑定"></a>一步步来实现Vue双向绑定</h1><p>参考文章：</p>
<p><a href="https://www.cnblogs.com/hekai123/p/7571744.html" target="_blank" rel="noopener">https://www.cnblogs.com/hekai123/p/7571744.html</a></p>
<p>双向绑定有两种实现方式，angular.js的脏值检查，vue的数据劫持（发布订阅）。</p>
<p>先看下一个极简的js双向绑定：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>极简双向绑定<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"a"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"b"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> obj = &#123;&#125;</span></span><br><span class="line"><span class="javascript"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">'hello'</span>, &#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">set</span>: <span class="function"><span class="keyword">function</span> <span class="params">(newVal)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'a'</span>).value = newVal</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'b'</span>).innerHTML = newVal</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.addEventListener(<span class="string">'keyup'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">  obj.hello = e.target.value</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（接下来还有代码的内容就只放body和js的内容了）</p>
<p>但是我们要实现的是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">	&lt;input type=<span class="string">"text"</span> v-model=<span class="string">"text"</span>&gt;</span><br><span class="line">	&#123;&#123;text&#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var <span class="keyword">vm</span> = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    <span class="keyword">e</span><span class="variable">l:</span> <span class="string">'#app'</span></span><br><span class="line">    dat<span class="variable">a:</span> &#123;</span><br><span class="line">        tex<span class="variable">t:</span> <span class="string">'hello world!'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在源码src/core/instance/index.js中有这Vue函数的声明：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">stateMixin(Vue)</span><br><span class="line">eventsMixin(Vue)</span><br><span class="line">lifecycleMixin(Vue)</span><br><span class="line">renderMixin(Vue)</span><br></pre></td></tr></table></figure>
<h3 id="documentFragment文档片段"><a href="#documentFragment文档片段" class="headerlink" title="documentFragment文档片段"></a>documentFragment文档片段</h3><p>在文档片段上操作DOM，不会影响到真实DOM，操作完成后再渲染真实DOM。</p>
<p>那我们先将vue函数实现，输入狂和文本节点与data中数据绑定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">"text"</span> v-model=<span class="string">"text"</span>&gt;</span><br><span class="line">  &#123;&#123;text&#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">function compile(node, vm) &#123;</span></span><br><span class="line"><span class="regexp">  var reg = /</span>\&#123;\&#123;(.*)\&#125;\&#125;/</span><br><span class="line">  <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> attr = node.attributes</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; attr.length; i++) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr[i].nodeName)</span><br><span class="line">      <span class="keyword">if</span> (attr[i].nodeName == <span class="string">'v-model'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = attr[i].nodeValue</span><br><span class="line">        node.value = vm.data[name]</span><br><span class="line">        node.removeAttribute(<span class="string">'v-model'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (node.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(node.nodeValue)) &#123;</span><br><span class="line">      <span class="keyword">var</span> name = <span class="built_in">RegExp</span>.$<span class="number">1</span></span><br><span class="line">      name = name.trim()</span><br><span class="line">      node.nodeValue = vm.data[name]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodeToFragment</span> (<span class="params">node, vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> flag = <span class="built_in">document</span>.createDocumentFragment()</span><br><span class="line">  <span class="keyword">var</span> child</span><br><span class="line">  <span class="keyword">while</span> (child = node.firstChild) &#123;</span><br><span class="line">    compile(child, vm)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Child"</span>+child)</span><br><span class="line">    flag.appendChild(child)<span class="comment">// 劫持子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> flag</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.data = options.data</span><br><span class="line">  <span class="keyword">var</span> id = options.el</span><br><span class="line">  <span class="keyword">var</span> dom = nodeToFragment(<span class="built_in">document</span>.getElementById(id), <span class="keyword">this</span>)</span><br><span class="line">  <span class="built_in">document</span>.getElementById(id).appendChild(dom)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    text: <span class="string">'hello world'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>跑一下可以看见数据已经绑定到输入框和文本中了。</p>
<p>但是这没有实时响应，接下来，我们将输入框内容和data的值绑定同步变化，接这上面的代码修改：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">node, vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> reg = <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span></span><br><span class="line">  <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> attr = node.attributes</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; attr.length; i++) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr[i].nodeName)</span><br><span class="line">      <span class="keyword">if</span> (attr[i].nodeName == <span class="string">'v-model'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = attr[i].nodeValue<span class="comment">// 获取v-model绑定的属性名</span></span><br><span class="line">        node.addEventListener(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">          vm[name] = e.target.value</span><br><span class="line">        &#125;)</span><br><span class="line">        node.value = vm.data[name]</span><br><span class="line">        node.removeAttribute(<span class="string">'v-model'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (node.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(node.nodeValue)) &#123;</span><br><span class="line">      <span class="keyword">var</span> name = <span class="built_in">RegExp</span>.$<span class="number">1</span></span><br><span class="line">      name = name.trim()</span><br><span class="line">      node.nodeValue = vm.data[name]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>已经实现了：修改输入框内容=》通过事件回调修改data属性值=》触发属性set方法</p>
<p>接下来做：发出通知dep.notify=》触发订阅者update=》更新视图</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">"text"</span> v-model=<span class="string">"text"</span>&gt;</span><br><span class="line">  &#123;&#123;text&#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">function Watcher (vm, node, name) &#123;</span></span><br><span class="line"><span class="regexp">  Dep.target = this</span></span><br><span class="line"><span class="regexp">  this.name = name</span></span><br><span class="line"><span class="regexp">  this.node = node</span></span><br><span class="line"><span class="regexp">  this.vm = vm</span></span><br><span class="line"><span class="regexp">  this.update()</span></span><br><span class="line"><span class="regexp">  Dep.target = null</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">Watcher.prototype = &#123;</span></span><br><span class="line"><span class="regexp">  update: function () &#123;</span></span><br><span class="line"><span class="regexp">    this.get()</span></span><br><span class="line"><span class="regexp">    this.node.nodeValue = this.value</span></span><br><span class="line"><span class="regexp">    console.log("watcher的update" + this.node.nodeValue)</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  get: function () &#123;</span></span><br><span class="line"><span class="regexp">    this.value = this.vm[this.name]</span></span><br><span class="line"><span class="regexp">    console.log("watcher的get" + this.value)</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">function Dep () &#123;</span></span><br><span class="line"><span class="regexp">  this.subs = []</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">Dep.prototype = &#123;</span></span><br><span class="line"><span class="regexp">  addSub: function (sub) &#123;</span></span><br><span class="line"><span class="regexp">    this.subs.push(sub)</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  notify: function () &#123;</span></span><br><span class="line"><span class="regexp">    this.subs.forEach(function (sub) &#123;</span></span><br><span class="line"><span class="regexp">      sub.update()</span></span><br><span class="line"><span class="regexp">    &#125;)</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function defineReactive(obj, key, val) &#123;</span></span><br><span class="line"><span class="regexp">  var dep = new Dep()</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ 响应数据绑定</span></span><br><span class="line"><span class="regexp">  Object.defineProperty(obj, key, &#123;</span></span><br><span class="line"><span class="regexp">    get: function () &#123;</span></span><br><span class="line"><span class="regexp">      if (Dep.target) &#123;</span></span><br><span class="line"><span class="regexp">        dep.addSub(Dep.target)</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return val</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    set: function (newVal) &#123;</span></span><br><span class="line"><span class="regexp">      if (newVal === val) &#123;</span></span><br><span class="line"><span class="regexp">        return</span></span><br><span class="line"><span class="regexp">      &#125; else &#123;</span></span><br><span class="line"><span class="regexp">        val = newVal</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ 发出通知</span></span><br><span class="line"><span class="regexp">        dep.notify()</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">function observe(obj, vm) &#123;</span></span><br><span class="line"><span class="regexp">  Object.keys(obj).forEach(function (key) &#123;</span></span><br><span class="line"><span class="regexp">    defineReactive(vm, key, obj[key])</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function compile(node, vm) &#123;</span></span><br><span class="line"><span class="regexp">  var reg = /</span>\&#123;\&#123;(.*)\&#125;\&#125;/</span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line">  <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> attr = node.attributes</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; attr.length; i++) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr[i].nodeName)</span><br><span class="line">      <span class="keyword">if</span> (attr[i].nodeName == <span class="string">'v-model'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = attr[i].nodeValue<span class="comment">// 获取v-model绑定的属性名</span></span><br><span class="line">        node.addEventListener(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">          vm[name] = e.target.value</span><br><span class="line">        &#125;)</span><br><span class="line">        node.value = vm.data[name]</span><br><span class="line">        node.removeAttribute(<span class="string">'v-model'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 节点</span></span><br><span class="line">  <span class="keyword">if</span> (node.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(node.nodeValue)) &#123;</span><br><span class="line">      <span class="keyword">var</span> name = <span class="built_in">RegExp</span>.$<span class="number">1</span></span><br><span class="line">      name = name.trim()</span><br><span class="line">      node.nodeValue = vm.data[name]</span><br><span class="line">      <span class="keyword">new</span> Watcher(vm, node, name)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodeToFragment</span> (<span class="params">node, vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> flag = <span class="built_in">document</span>.createDocumentFragment()</span><br><span class="line">  <span class="keyword">var</span> child</span><br><span class="line">  <span class="keyword">while</span> (child = node.firstChild) &#123;</span><br><span class="line">    compile(child, vm)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Child"</span>+child)</span><br><span class="line">    flag.appendChild(child)<span class="comment">// 劫持子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> flag</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.data = options.data</span><br><span class="line">  <span class="keyword">var</span> data = <span class="keyword">this</span>.data</span><br><span class="line"></span><br><span class="line">  observe(data, <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> id = options.el</span><br><span class="line">  <span class="keyword">var</span> dom = nodeToFragment(<span class="built_in">document</span>.getElementById(id), <span class="keyword">this</span>)</span><br><span class="line">  <span class="built_in">document</span>.getElementById(id).appendChild(dom)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    text: <span class="string">'hello world'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/01/13/Vue源码学习/" data-id="ck0n5hj9b0005p4uyw1r7kgt1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/wdzhao.github.io/2019/04/23/记一次Element组件-侧导航栏/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          记一次Element组件-侧导航栏
        
      </div>
    </a>
  
  
    <a href="/wdzhao.github.io/2019/01/01/十大经典算法-优化篇/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">十大经典算法-优化篇</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/wdzhao.github.io/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/wdzhao.github.io/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/wdzhao.github.io/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/wdzhao.github.io/archives/2018/10/">十月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/wdzhao.github.io/2019/04/23/记一次Element组件-侧导航栏/">记一次Element组件-侧导航栏</a>
          </li>
        
          <li>
            <a href="/wdzhao.github.io/2019/01/13/Vue源码学习/">Vue源码学习</a>
          </li>
        
          <li>
            <a href="/wdzhao.github.io/2019/01/01/十大经典算法-优化篇/">十大经典算法-优化篇</a>
          </li>
        
          <li>
            <a href="/wdzhao.github.io/2018/11/21/Scrapy框架/">Scrapy框架</a>
          </li>
        
          <li>
            <a href="/wdzhao.github.io/2018/11/19/python基础/">python基础</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 赵卫东<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/wdzhao.github.io/" class="mobile-nav-link">Home</a>
  
    <a href="/wdzhao.github.io/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/wdzhao.github.io/fancybox/jquery.fancybox.css">
  <script src="/wdzhao.github.io/fancybox/jquery.fancybox.pack.js"></script>


<script src="/wdzhao.github.io/js/script.js"></script>



  </div>
</body>
</html>